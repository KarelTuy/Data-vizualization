<script>import { setContext, onDestroy } from "svelte";
import { writable } from "svelte/store";
export let data = [];
const DEFAULT_OPTIONS = {
  key: "",
  unit: "%",
  max: 100
};
export let options = {
  ...DEFAULT_OPTIONS
};
export let interval = 2e3;
export let currentValue = null;
const value = writable(currentValue ?? -1);
const valuesByKey = writable({});
const range = writable([]);
const chartOptions = writable({ ...DEFAULT_OPTIONS, ...options });
const context = {
  value,
  valuesByKey,
  range,
  chartOptions,
  setValue: (_value) => value.set(_value)
};
setContext("BarChartRace", context);
$:
  if (!options.key) {
    options = {
      ...options,
      // infer the data key by finding the first field that is not "value"
      key: Object.keys(data[0]?.values[0] ?? {}).find((key) => key !== "value")
    };
  }
$:
  valuesByKey.set(
    data.flatMap(
      (datum) => datum.values.map((values) => ({ ...datum, ...values }))
    ).reduce((values, value2) => {
      const currentKey = value2[options.key];
      const currentValue2 = values[value2[options.key]];
      values[currentKey] = currentValue2 ? [...currentValue2, value2].sort((a, b) => b.value - a.value) : [value2];
      return values;
    }, {})
  );
$:
  range.set(Object.keys($valuesByKey).map((_value) => Number(_value)));
$:
  if ($value === -1)
    value.set($range[0]);
$:
  value.set(currentValue == null ? $range[0] : currentValue);
$:
  currentValue = $value;
$:
  chartOptions.set({ ...DEFAULT_OPTIONS, ...options });
let isPlaying = false;
let timer;
let currentIndex = 0;
$:
  currentIndex = $range.indexOf($value);
$:
  didEnd = currentIndex === $range.length - 1;
$:
  if (isPlaying && didEnd)
    clearTimer();
const clearTimer = () => {
  isPlaying = false;
  clearInterval(timer);
};
const animate = () => {
  currentIndex += 1;
  value.set($range[currentIndex]);
};
const play = () => {
  if (didEnd) {
    currentIndex = 0;
    value.set($range[currentIndex]);
  } else {
    animate();
  }
  isPlaying = true;
  timer = setInterval(animate, interval);
};
onDestroy(clearTimer);
</script>

<slot
  {currentValue}
  {isPlaying}
  setMax={() => value.set($range[$range.length - 1])}
  setMin={() => value.set($range[0])}
  setValue={context.setValue}
  {play}
  pause={clearTimer}
/>
